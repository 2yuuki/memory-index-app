<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HyperCard Memory Index</title>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.11.11/lib/p5.js"></script>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://use.typekit.net/ptv6ncb.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* --- Artboard UI Enhancements --- */
    .artboard-wrapper {
      margin-bottom: 40px;
      transition: transform 0.2s, opacity 0.2s;
      cursor: grab;
    }
    .artboard-wrapper.dragging {
      opacity: 0.5;
      transform: scale(0.98);
      cursor: grabbing;
    }
    .artboard-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      height: 30px;
    }
    .artboard-label {
      font-family: 'HypertextMono', monospace;
      font-size: 14px;
      padding: 2px 8px;
      border: 1px solid transparent;
      cursor: text;
      min-width: 100px;
      text-align: center;
    }
    .artboard-label:hover {
      border: 1px dashed #aaa;
    }
    .artboard-label-input {
      font-family: 'HypertextMono', monospace;
      font-size: 14px;
      text-align: center;
      width: 150px;
      border: 1px solid var(--tab-blue);
      outline: none;
      background: var(--white);
    }
    .btn-icon {
      background: var(--white);
      border: 1px solid #ccc;
      cursor: pointer;
      font-size: 16px;
      width: 30px;
      height: 30px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn-icon:hover {
      background: #f0f0f0;
      transform: translateY(-1px);
    }
    /* Fix for paper pattern in Index Tab */
    #tab-index .paper-sheet {
      position: relative;
      background-image: none;
      background-color: #fff;
    }
    #tab-index .paper-sheet::before {
      content: "";
      position: absolute;
      top: 50%; left: 50%;
      width: 842px; height: 595px; /* Swapped A4 dimensions for rotation */
      background-image: url('assets/canvas%20template/paper%20pattern%201.png');
      background-size: 100% 100%;
      transform: translate(-50%, -50%) rotate(90deg);
      z-index: 0;
      pointer-events: none;
    }
    #tab-index .paper-sheet > div {
      position: relative;
      z-index: 1;
    }
  </style>
</head>
<body>

<div id="app-container">

  <!-- NEW TOP BAR (Navigation) -->
  <div class="new-top-bar">
    <div class="top-nav-btn active" onclick="switchSidebar('intro')">I. Introduction</div>
    <div class="top-nav-btn" onclick="switchSidebar('tools')">II. Tool Tab</div>
  </div>

  <div class="content-row" style="display:flex; flex:1; overflow:hidden;">
    
    <!-- NEW SIDEBAR (Tabs) -->
    <div class="new-sidebar disabled">
      <div class="v-tab-btn active" data-tab="tab-input">1. Memories Input</div>
      <div class="v-tab-btn" data-tab="tab-sketch">2. Memories ASCII Sketch</div>
      <div class="v-tab-btn" data-tab="tab-index">3. The Memory Diagram</div>
      <div class="v-tab-btn" data-tab="tab-layout">4. Paper Memory Teller</div>
    </div>

    <!-- LIBRARY OVERLAY (Pinned) -->
    <div class="library-overlay" id="libOverlay">
      <div class="library-toggle" onclick="toggleLibrary()">üìö</div>
      <div class="section-title" style="padding:10px;">Library</div>
      <div id="lib-grid" class="lib-grid" style="padding:10px; overflow-y:auto;"></div>
    </div>

  <!-- INTRO VIEW -->
  <div id="intro-view" class="intro-container">
    <div class="intro-content">
      <h1 class="section-title" style="font-size:36px; text-align:center; margin-bottom:10px; color:var(--black);">Index of Remembering</h1>
      <p style="text-align:center; color:var(--text-muted); font-family:'HypertextMono'; text-transform:none; margin-bottom:10px;">
        A Digital Archive for your Fragmented Memories
      </p>
      
      <div class="intro-grid">
        <!-- Step 1 -->
        <div class="intro-card">
          <div class="intro-step-num">01</div>
          <h3 class="intro-step-title">Input & Process</h3>
          <p class="intro-desc">
            Start by writing your thoughts or uploading an image. 
            The system uses <strong>CMYK ASCII</strong> algorithms to convert your memories into digital textures.
            <br><br>
            <em>Tip: Try the 'Dither' mode for a retro look.</em>
          </p>
        </div>

        <!-- Step 2 -->
        <div class="intro-card">
          <div class="intro-step-num">02</div>
          <h3 class="intro-step-title">Sketch & Refine</h3>
          <p class="intro-desc">
            Switch to the <strong>Sketch Tab</strong> to edit your artwork. 
            Use the <strong>Smart Brush</strong> for directional strokes or the <strong>Bucket</strong> to fill areas.
            <br><br>
            <em>Tip: Press 'Add to Library' to save your work.</em>
          </p>
        </div>

        <!-- Step 3 -->
        <div class="intro-card">
          <div class="intro-step-num">03</div>
          <h3 class="intro-step-title">Layout & Export</h3>
          <p class="intro-desc">
            Go to the <strong>Index Tab</strong> to organize your collection. 
            Drag items from the library onto the A4 sheet. Arrange, resize, and <strong>Export</strong> your final memory sheet.
          </p>
        </div>
      </div>

      <div style="display:flex; justify-content:center; gap:20px;">
        <button class="btn-retro" style="width:200px; height:50px; font-size:16px; font-weight:bold;" onclick="switchSidebar('tools')">ENTER SYSTEM</button>
      </div>
    </div>
  </div>

  <div class="app-body" id="main-app-body" style="display:none;">

  <!-- TAB 1 -->
  <div class="workspace active" id="tab-input">
    
    <!-- Left Panel with Sub-tabs -->
    <div class="panel-left" style="padding:0; background:transparent;">
      
      <!-- Sub-tab Navigation -->
      <div class="sub-tab-header">
        <div class="sub-tab-btn active" onclick="switchSubTab('thoughts')" style="background:var(--thoughts-bg); color:var(--thoughts-text);">1/ WRITE THOUGHTS</div>
        <div class="sub-tab-btn" onclick="switchSubTab('processor')" style="background:var(--proc-bg); color:var(--proc-text);">2/ IMAGE PROCESSOR</div>
      </div>

      <!-- Sub-tab 1: Thoughts -->
      <div id="sub-thoughts" style="padding:14px; background:var(--thoughts-bg); height:100%; display:flex; flex-direction:column; gap:10px;">
        <div class="section-title" style="color:var(--thoughts-text);">Write your thoughts here</div>
        <textarea id="inpThought" class="retro-input" placeholder="Type thoughts..." style="flex:1; border-color:var(--thoughts-text);"></textarea>
        <button class="btn-retro" id="btnCreateCard" style="background:var(--white); color:var(--thoughts-text); border-color:var(--thoughts-text);">+ ADD THOUGHTS</button>
      </div>

      <!-- Sub-tab 2: Image Processor -->
      <div id="sub-processor" style="padding:14px; background:var(--proc-bg); height:100%; display:none; flex-direction:column; gap:10px; overflow-y:auto;">
        <div class="section-title" style="color:var(--proc-text); margin-top:0;">Image Input</div>
        <div class="dashed-preview" id="preview-area" style="border-color:var(--proc-text);"><span class="muted">EMPTY</span></div>
        <button class="btn-retro" id="btnLoadImage" style="background:var(--white); color:var(--proc-text); border-color:var(--proc-text);">+ LOAD IMAGE</button>
        <input type="file" id="fileIn" hidden />

        <div class="divider" style="background:var(--proc-text); opacity:0.3;"></div>

        <div class="section-title" style="color:var(--proc-text);">ASCII Options</div>
        <div class="mini-row" style="color:var(--proc-text);">
          <span>Ink Type</span>
          <select id="selColorMode" class="retro-input" style="width:120px; height:24px; padding:0; border-color:var(--proc-text);">
            <option value="cmyk">CMYK Marker</option>
            <option value="stabilo">Stabilo Marker</option>
            <option value="mono">Monochrome</option>
            <option value="dither">Dither</option>
            <option value="image">Original</option>
          </select>
        </div>
        <div class="mini-row" style="color:var(--proc-text);">
          <span>Pattern</span>
          <input type="range" id="cfgWeight" min="0.5" max="3" step="0.1" value="2.5">
        </div>
        <div class="mini-row" style="color:var(--proc-text);">
          <span>Preset</span>
          <select id="selAsciiPreset" class="retro-input" style="width:120px; height:24px; padding:0; border-color:var(--proc-text);"></select>
        </div>
        <div class="mini-row" style="color:var(--proc-text);">
          <span>Threshold</span>
          <input type="range" id="cfgDensity" min="0.1" max="2" step="0.1" value="1.5">
        </div>
        
        <div class="mini-row" style="color:var(--proc-text);">
          <label class="chk"><input type="checkbox" id="chkInvert" checked> Invert</label>
          <label class="chk"><input type="checkbox" id="chkShowSrc"> Source</label>
          <label class="chk"><input type="checkbox" id="chkAnimate"> Animate</label>
        </div>

        <button class="btn-retro btn-wide" id="cmykSaveBtn" style="background:var(--white); color:var(--proc-text); border-color:var(--proc-text);">+ ADD TO LIBRARY</button>
        <button class="btn-retro btn-wide" id="btnSavePNG" style="margin-top:6px; background:var(--white); color:var(--proc-text); border-color:var(--proc-text);">DOWNLOAD IMAGE</button>
        <button class="btn-retro btn-wide" id="btnSaveTXT" style="margin-top:6px; background:var(--white); color:var(--proc-text); border-color:var(--proc-text);">DOWNLOAD TXT</button>
      </div>
    </div>

    <div class="panel-center">
      <div class="paper-sheet paper-a4">
        <div id="input-canvas-holder" class="canvas-holder"></div>
      </div>
    </div>
  </div>

  <!-- TAB 2 -->
  <div class="workspace" id="tab-sketch">
    <div class="panel-left ribbon ribbon-green" data-ribbon="2. Sketch">
      <div class="section-title">Tools</div>
      <button class="btn-retro" id="btnPencil">‚úèÔ∏è Pencil</button>
      <button class="btn-retro" id="btnEraser">üßº Eraser</button>
      <button class="btn-retro" id="btnFill">ü™£ Bucket</button>
      <button class="btn-retro" id="btnClearSketch">üóëÔ∏è Clear</button>

      <div class="divider"></div>

      <div class="section-title">Patterns</div>
      <div id="sketch-palette" class="palette-grid"></div>

      <div class="section-title">Ink</div>
      <div id="sketch-colors" class="palette-grid palette-ink"></div>

    </div>

    <div style="position:relative; width:100%; height:100%; overflow:auto; background:#d0d0d0;">
      <div id="sketch-canvas-holder" style="padding: 20px;"></div>
      <div class="zoom-float" style="position:absolute; right:20px; bottom:20px; top:auto; transform:none;">
        <button class="btn-zoom" id="btnSketchZoomOut">-</button>
        <span id="sketch-zoom-val" class="zoom-text">100%</span>
        <button class="btn-zoom" id="btnSketchZoomIn">+</button>
      </div>
    </div>
  </div>

  <!-- TAB 3 -->
  <div class="workspace" id="tab-index">
    <div class="panel-left ribbon ribbon-green" data-ribbon="3. Index">
      <div class="section-title">Tools</div>
      <button class="btn-retro" id="btnSelectTool" title="Selection Tool">üñ±Ô∏è Select</button>
      <button class="btn-retro btn-wide" id="btnExportLayout">export A4</button>
    </div>

    <div class="panel-center" style="flex-direction:column; justify-content:flex-start; overflow-y:auto; padding-top:20px;">
      <div class="artboard-wrapper" draggable="true">
        <div class="artboard-header">
          <span class="artboard-label" ondblclick="makeEditable(this)">Artboard 1</span>
          <button class="btn-icon" onclick="duplicateArtboard(this)" title="Duplicate Artboard">‚ùê</button>
        </div>
        <div class="paper-sheet paper-a4 fixed-a4">
          <div id="layout-canvas-holder" style="width:100%; height:100%;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB 4 (placeholder gi·ªëng ·∫£nh) -->
  <div class="workspace" id="tab-layout">
    <div class="panel-left ribbon ribbon-green" data-ribbon="4. Paper">
      <div class="section-title">Paper Memories</div>
      <div class="muted">Placeholder tab (you can plug your layout/export here).</div>
    </div>
    <div class="panel-center">
      <div class="paper-sheet paper-a4"></div>
    </div>
  </div>
  
  </div><!-- end app-body -->
  </div><!-- end content-row -->

</div>

<script src="sketch.js"></script>
<script src="cmyk-ascii-effect.js"></script>
<script src="ui-binding.js"></script>
<script>
  // T·ª± ƒë·ªông s·ª≠a l·ªói SVG kh√¥ng gi√£n (stretch) b·∫±ng c√°ch th√™m preserveAspectRatio="none"
  async function fixSvgStretch(selector, url) {
    try {
      const resp = await fetch(url);
      if (!resp.ok) return;
      let svgText = await resp.text();
      
      // Th√™m thu·ªôc t√≠nh preserveAspectRatio="none" ƒë·ªÉ cho ph√©p gi√£n h√¨nh
      if (svgText.includes('<svg')) {
        if (svgText.includes('preserveAspectRatio')) {
          svgText = svgText.replace(/preserveAspectRatio="[^"]*"/, 'preserveAspectRatio="none"');
        } else {
          svgText = svgText.replace('<svg', '<svg preserveAspectRatio="none"');
        }
        const encoded = encodeURIComponent(svgText).replace(/'/g, '%27').replace(/\(/g, '%28').replace(/\)/g, '%29');
        document.querySelectorAll(selector).forEach(el => {
          el.style.backgroundImage = `url("data:image/svg+xml;charset=utf-8,${encoded}")`;
        });
      }
    } catch (e) { console.warn('SVG Fix skipped (needs local server):', e); }
  }
  // √Åp d·ª•ng fix cho top-bar v√† panel-center
  //fixSvgStretch('.top-bar', 'assets/UI%20items/top-bar.svg');
  //fixSvgStretch('.panel-center', 'assets/UI%20items/panel-center.svg');
  //fixSvgStretch('.panel-left', 'assets/UI%20items/panel-left.svg');
  //fixSvgStretch('.sidebar-bg-rotated', 'assets/UI%20items/top-bar.svg');

  // Initialize Drag and Drop for existing artboards
  document.querySelectorAll('.artboard-wrapper').forEach(el => addDnDHandlers(el));

  // Sidebar Switch Logic
  window.switchSidebar = function(mode) {
    const introView = document.getElementById('intro-view');
    const appBody = document.getElementById('main-app-body');
    const topNavBtns = document.querySelectorAll('.top-nav-btn');
    const sidebar = document.querySelector('.new-sidebar');

    if (mode === 'intro') {
      introView.style.display = 'flex';
      appBody.style.display = 'none';
      if(sidebar) sidebar.classList.add('disabled');
      // FIX: Loop qua tabs ƒë·ªÉ active ƒë√∫ng c√°i c·∫ßn thi·∫øt thay v√¨ hardcode index
      topNavBtns.forEach(t => {
        if(t.textContent.includes('Introduction')) t.classList.add('active');
        else t.classList.remove('active');
      });
    } else {
      introView.style.display = 'none';
      appBody.style.display = 'flex'; // Ensure flex layout
      if(sidebar) sidebar.classList.remove('disabled');
      topNavBtns.forEach(t => {
        if(t.textContent.includes('Tool')) t.classList.add('active');
        else t.classList.remove('active');
      });
    }

    // --- Export TXT Function ---
    document.getElementById('btnSaveTXT').addEventListener('click', () => {
      let content = "";
      // 1. Try to get text from DOM (if Show Source is on)
      const pre = document.querySelector('#input-canvas-holder pre');
      if(pre) content = pre.innerText;
      
      // 2. Fallback: Check global variable (You must set window.currentAsciiText in your JS)
      if(!content && window.currentAsciiText) content = window.currentAsciiText;

      if(!content) {
        alert("No ASCII text found. \nTip: Enable 'Show Source' or ensure window.currentAsciiText is set.");
        return;
      }

      const blob = new Blob([content], {type: "text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "memory_ascii.txt";
      a.click();
      URL.revokeObjectURL(url);
    });
  }

  window.duplicateArtboard = function(btn) {
    const wrapper = btn.closest('.artboard-wrapper');
    const clone = wrapper.cloneNode(true);
    
    // Update Name
    const label = clone.querySelector('.artboard-label');
    const currentName = label.innerText;
    const match = currentName.match(/(\d+)$/);
    if(match) {
      label.innerText = currentName.replace(/\d+$/, parseInt(match[1]) + 1);
    } else {
      label.innerText = currentName + " Copy";
    }

    // Update ID to avoid duplicates
    const canvasHolder = clone.querySelector('[id^="layout-canvas-holder"]');
    if(canvasHolder) {
      canvasHolder.id = "layout-canvas-holder-" + Date.now();
    }
    
    // Copy Canvas content if any (in case p5.js or other canvas is used)
    const oldCanvases = wrapper.querySelectorAll('canvas');
    const newCanvases = clone.querySelectorAll('canvas');
    if(oldCanvases.length > 0 && oldCanvases.length === newCanvases.length) {
      oldCanvases.forEach((oldCv, i) => {
        const newCv = newCanvases[i];
        const ctx = newCv.getContext('2d');
        if(ctx) ctx.drawImage(oldCv, 0, 0);
      });
    }

    // Re-attach Drag and Drop handlers
    addDnDHandlers(clone);

    wrapper.parentNode.insertBefore(clone, wrapper.nextSibling);
  }

  // --- Rename Logic ---
  window.makeEditable = function(el) {
    const input = document.createElement('input');
    input.type = 'text';
    input.value = el.innerText;
    input.className = 'artboard-label-input';
    input.onblur = function() { saveLabel(this); };
    input.onkeydown = function(e) { if(e.key === 'Enter') saveLabel(this); };
    el.parentNode.replaceChild(input, el);
    input.focus();
  }

  window.saveLabel = function(input) {
    const span = document.createElement('span');
    span.className = 'artboard-label';
    span.innerText = input.value;
    span.ondblclick = function() { makeEditable(this); };
    input.parentNode.replaceChild(span, input);
  }

  // --- Drag and Drop Logic ---
  let dragSrcEl = null;
  function handleDragStart(e) {
    dragSrcEl = this;
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
    this.classList.add('dragging');
  }
  function handleDragOver(e) {
    if (e.preventDefault) e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    return false;
  }
  function handleDrop(e) {
    if (e.stopPropagation) e.stopPropagation();
    if (dragSrcEl !== this) {
      const parent = this.parentNode;
      const nodes = Array.from(parent.children);
      if (nodes.indexOf(dragSrcEl) < nodes.indexOf(this)) {
        parent.insertBefore(dragSrcEl, this.nextSibling);
      } else {
        parent.insertBefore(dragSrcEl, this);
      }
    }
    return false;
  }
  function handleDragEnd(e) { this.classList.remove('dragging'); }
  function addDnDHandlers(elem) {
    elem.addEventListener('dragstart', handleDragStart, false);
    elem.addEventListener('dragover', handleDragOver, false);
    elem.addEventListener('drop', handleDrop, false);
    elem.addEventListener('dragend', handleDragEnd, false);
  }

  // --- PDF Export Logic ---
  // Replace the export button to handle multiple artboards PDF export
  const btnExport = document.getElementById('btnExportLayout');
  if(btnExport) {
    const newBtn = btnExport.cloneNode(true);
    btnExport.parentNode.replaceChild(newBtn, btnExport);
    
    newBtn.addEventListener('click', async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');
      const artboards = document.querySelectorAll('#tab-index .paper-sheet');
      
      if(artboards.length === 0) return;

      newBtn.textContent = "Generating PDF...";
      newBtn.style.cursor = "wait";

      for (let i = 0; i < artboards.length; i++) {
        const sheet = artboards[i];
        const canvas = await html2canvas(sheet, { scale: 2, useCORS: true });
        const imgData = canvas.toDataURL('image/jpeg', 0.9);
        const imgWidth = 210; 
        const pageHeight = 297; 
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        if (i > 0) doc.addPage();
        doc.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
      }
      
      doc.save('memory-index.pdf');
      newBtn.textContent = "export A4";
      newBtn.style.cursor = "pointer";
    });
  }

  // --- Sub-tab Logic for Tab 1 ---
  window.switchSubTab = function(tabName) {
    const thoughts = document.getElementById('sub-thoughts');
    const processor = document.getElementById('sub-processor');
    const btns = document.querySelectorAll('.sub-tab-btn');

    if(tabName === 'thoughts') {
      thoughts.style.display = 'flex';
      processor.style.display = 'none';
      btns[0].classList.add('active');
      btns[1].classList.remove('active');
    } else {
      thoughts.style.display = 'none';
      processor.style.display = 'flex';
      btns[0].classList.remove('active');
      btns[1].classList.add('active');
    }
  }

  // --- Library Toggle ---
  window.toggleLibrary = function() {
    document.getElementById('libOverlay').classList.toggle('open');
  }
</script>

</body>
</html>
